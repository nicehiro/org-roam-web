{{template "base" .}}

{{define "title"}}{{.Title}} | {{.Site.Title}}{{end}}

{{define "head"}}
<style>
  .note-page {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 2rem;
    padding: 2rem 0;
  }

  .note-main {
    min-width: 0;
  }

  .note-header {
    margin-bottom: 2rem;
  }

  .note-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 0.75rem;
  }

  .note-meta {
    margin-bottom: 0.5rem;
  }

  .note-date {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .note-tags {
    margin-bottom: 1rem;
  }

  .note-content {
    line-height: 1.7;
  }

  .note-content h1 { font-size: 1.75rem; margin: 2rem 0 1rem; font-weight: 600; }
  .note-content h2 { font-size: 1.5rem; margin: 1.75rem 0 0.875rem; font-weight: 600; }
  .note-content h3 { font-size: 1.25rem; margin: 1.5rem 0 0.75rem; font-weight: 600; }
  .note-content h4 { font-size: 1.125rem; margin: 1.25rem 0 0.625rem; font-weight: 600; }

  .note-content p {
    margin: 1rem 0;
  }

  .note-content ul, .note-content ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .note-content li {
    margin: 0.375rem 0;
  }

  .note-content img {
    margin: 1.5rem 0;
  }

  /* Sidebar */
  .sidebar {
    position: sticky;
    top: 1rem;
    height: fit-content;
  }

  .sidebar-section {
    margin-bottom: 2rem;
  }

  .sidebar-section h3 {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .local-graph {
    width: 100%;
    height: 200px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
  }

  .local-graph-tooltip {
    position: fixed;
    padding: 0.375rem 0.5rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    color: var(--text-primary);
    pointer-events: none;
    z-index: 100;
    display: none;
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .local-graph-tooltip.active {
    display: block;
  }

  .link-list {
    list-style: none;
    padding: 0;
  }

  .link-list li {
    margin: 0.375rem 0;
  }

  .link-list a {
    display: flex;
    align-items: flex-start;
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.4;
  }

  .link-list a:hover {
    color: var(--accent);
  }

  .link-list .link-marker {
    color: var(--text-muted);
    margin-right: 0.375rem;
    flex-shrink: 0;
  }

  .link-list .link-title {
    flex: 1;
    min-width: 0;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .back-link:hover {
    color: var(--accent);
  }

  /* Table of Contents */
  .toc {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc-item {
    color: var(--text-secondary);
    font-size: 0.8125rem;
    line-height: 1.4;
    display: block;
  }

  .toc-item:hover {
    color: var(--accent);
  }

  .toc-level-3 {
    padding-left: 0.75rem;
    font-size: 0.75rem;
  }

  /* ============================================
     MOBILE RESPONSIVE - NOTE PAGE
     ============================================ */
  
  @media (max-width: 768px) {
    .note-page {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 1.5rem 0;
    }

    /* Sidebar moves below content */
    .sidebar {
      order: 1;
      position: static;
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
      margin-top: 0.5rem;
    }

    .note-header {
      margin-bottom: 1.5rem;
    }

    .note-title {
      font-size: 1.5rem;
      line-height: 1.3;
    }

    .note-content {
      line-height: 1.65;
    }

    .note-content h1 { font-size: 1.375rem; margin: 1.5rem 0 0.75rem; }
    .note-content h2 { font-size: 1.25rem; margin: 1.25rem 0 0.625rem; }
    .note-content h3 { font-size: 1.125rem; margin: 1rem 0 0.5rem; }
    .note-content h4 { font-size: 1rem; margin: 0.875rem 0 0.5rem; }

    .note-content p {
      margin: 0.875rem 0;
    }

    .note-content ul, .note-content ol {
      padding-left: 1.25rem;
    }

    .back-link {
      font-size: 0.8125rem;
    }

    .local-graph {
      height: 180px;
    }

    .link-list a {
      font-size: 0.8125rem;
    }

    .toc-item {
      font-size: 0.75rem;
    }

    .toc-level-3 {
      font-size: 0.7rem;
    }
  }

  /* Tablet */
  @media (min-width: 769px) and (max-width: 1024px) {
    .note-page {
      grid-template-columns: 1fr 240px;
      gap: 1.5rem;
    }

    .note-title {
      font-size: 1.75rem;
    }
  }
</style>
{{end}}

{{define "content"}}
<main class="container">
  <div class="note-page">
    <article class="note-main">
      <a href="{{.Site.BaseURL}}/" class="back-link">← Home</a>
      
      <header class="note-header">
        <h1 class="note-title">{{.Title}}</h1>
        <div class="note-meta">
          <span class="note-date">{{formatDate .ModTime}}</span>
        </div>
        {{if .Tags}}
        <div class="note-tags tags">
          {{range .Tags}}<a href="{{$.Site.BaseURL}}/tags/{{.}}.html" class="tag">{{.}}</a>{{end}}
        </div>
        {{end}}
      </header>

      <div class="note-content">
        {{.Content}}
      </div>
    </article>

    <aside class="sidebar">
      {{if .ToC}}
      <section class="sidebar-section">
        <h3>Contents</h3>
        <nav class="toc">
          {{range .ToC}}
          <a href="#{{.ID}}" class="toc-item toc-level-{{.Level}}">{{.Title}}</a>
          {{end}}
        </nav>
      </section>
      {{end}}

      {{if .HasGraph}}
      <section class="sidebar-section">
        <h3>Local Graph</h3>
        <div class="local-graph-container">
          <canvas id="local-graph" class="local-graph"></canvas>
        </div>
        <div class="local-graph-tooltip" id="local-graph-tooltip"></div>
      </section>
      {{end}}

      {{if .Links}}
      <section class="sidebar-section">
        <h3>Links</h3>
        <ul class="link-list">
          {{range .Links}}
          <li><a href="{{$.Site.BaseURL}}/notes/{{.ID}}.html"><span class="link-marker">#</span> <span class="link-title">{{.Title}}</span></a></li>
          {{end}}
        </ul>
      </section>
      {{end}}

      {{if .Backlinks}}
      <section class="sidebar-section">
        <h3>Backlinks</h3>
        <ul class="link-list">
          {{range .Backlinks}}
          <li><a href="{{$.Site.BaseURL}}/notes/{{.ID}}.html"><span class="link-marker">←</span> <span class="link-title">{{.Title}}</span></a></li>
          {{end}}
        </ul>
      </section>
      {{end}}
    </aside>
  </div>
</main>
{{end}}

{{define "scripts"}}
{{if .HasGraph}}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  const graphData = {{.LocalGraph}};
  const currentNodeId = "{{.ID}}";
  
  const canvas = document.getElementById('local-graph');
  const ctx = canvas.getContext('2d');
  const tooltip = document.getElementById('local-graph-tooltip');
  
  let width, height;
  let simulation;
  let transform = d3.zoomIdentity;

  // Create node map for quick lookup
  const nodeMap = new Map(graphData.nodes.map(n => [n.id, n]));

  // Resize function
  function resize() {
    const rect = canvas.getBoundingClientRect();
    width = rect.width;
    height = rect.height;
    canvas.width = width * window.devicePixelRatio;
    canvas.height = height * window.devicePixelRatio;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    
    if (simulation) {
      simulation.force('center', d3.forceCenter(width / 2, height / 2));
      simulation.alpha(0.3).restart();
    }
  }

  // Initialize simulation
  function initSimulation() {
    simulation = d3.forceSimulation(graphData.nodes)
      .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(50))
      .force('charge', d3.forceManyBody().strength(-100))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(12));

    simulation.on('tick', render);
  }

  // Render with transform
  function render() {
    ctx.save();
    ctx.clearRect(0, 0, width, height);
    ctx.translate(transform.x, transform.y);
    ctx.scale(transform.k, transform.k);
    
    // Draw links
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
    ctx.lineWidth = 1 / transform.k;
    graphData.links.forEach(link => {
      const source = typeof link.source === 'object' ? link.source : nodeMap.get(link.source);
      const target = typeof link.target === 'object' ? link.target : nodeMap.get(link.target);
      if (source && target && source.x != null && target.x != null) {
        ctx.beginPath();
        ctx.moveTo(source.x, source.y);
        ctx.lineTo(target.x, target.y);
        ctx.stroke();
      }
    });

    // Draw nodes
    graphData.nodes.forEach(node => {
      if (node.x == null) return;
      const isCurrent = node.id === currentNodeId;
      const radius = isCurrent ? 8 : 5;
      ctx.beginPath();
      ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI);
      ctx.fillStyle = isCurrent 
        ? getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()
        : getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim();
      ctx.fill();
    });

    ctx.restore();
  }

  // Zoom behavior
  const zoom = d3.zoom()
    .scaleExtent([0.5, 2])
    .on('zoom', (event) => {
      transform = event.transform;
      render();
    });

  d3.select(canvas).call(zoom);

  // Find node at coordinates (accounting for transform)
  function findNodeAt(screenX, screenY) {
    const [x, y] = transform.invert([screenX, screenY]);
    for (const node of graphData.nodes) {
      if (node.x == null) continue;
      const dx = node.x - x;
      const dy = node.y - y;
      const radius = node.id === currentNodeId ? 8 : 5;
      if (dx * dx + dy * dy < (radius + 5) * (radius + 5)) {
        return node;
      }
    }
    return null;
  }

  // Handle click
  canvas.addEventListener('click', (e) => {
    const node = findNodeAt(e.offsetX, e.offsetY);
    if (node) {
      window.location.href = '{{.Site.BaseURL}}/notes/' + node.id + '.html';
    }
  });

  // Show tooltip on hover
  canvas.addEventListener('mousemove', (e) => {
    const node = findNodeAt(e.offsetX, e.offsetY);
    
    if (node) {
      canvas.style.cursor = 'pointer';
      // Unescape LaTeX and render
      const title = unescapeLatex(node.title);
      tooltip.innerHTML = title;
      renderMathInElement(tooltip, katexOptions);
      tooltip.style.left = (e.clientX + 10) + 'px';
      tooltip.style.top = (e.clientY + 10) + 'px';
      tooltip.classList.add('active');
    } else {
      canvas.style.cursor = 'grab';
      tooltip.classList.remove('active');
    }
  });

  canvas.addEventListener('mouseleave', () => {
    tooltip.classList.remove('active');
  });

  // Initialize
  window.addEventListener('resize', resize);
  resize();
  initSimulation();
</script>
{{end}}
{{end}}
