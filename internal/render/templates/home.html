{{template "base" .}}

{{define "title"}}{{.Site.Title}}{{end}}

{{define "head"}}
<style>
  .home-content {
    padding: 3rem 0;
  }

  .search-section {
    margin-bottom: 3rem;
  }

  .recent-section h2 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .note-list {
    list-style: none;
    padding: 0;
  }

  .note-item {
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
  }

  .note-item:first-child {
    padding-top: 0;
  }

  .note-item:last-child {
    border-bottom: none;
  }

  .note-row {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.375rem 1rem;
  }

  .note-title {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
  }

  .note-title:hover {
    color: var(--accent);
  }

  .note-tags {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-left: auto;
  }

  .note-tags .tag {
    font-size: 0.6875rem;
  }

  /* ============================================
     MOBILE RESPONSIVE - HOME PAGE
     ============================================ */
  
  @media (max-width: 768px) {
    .home-content {
      padding: 1.5rem 0;
    }

    .search-section {
      margin-bottom: 2rem;
    }

    .search-shortcut {
      display: none;
    }

    .search-input {
      padding: 0.625rem 0.875rem;
      font-size: 0.9375rem;
    }

    .note-item {
      padding: 0.875rem 0;
    }

    .note-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.375rem;
    }

    .note-title {
      font-size: 0.9375rem;
      line-height: 1.4;
    }

    .note-tags {
      margin-left: 0;
    }

    .note-tags .tag {
      font-size: 0.625rem;
    }

    .recent-section h2 {
      font-size: 0.75rem;
    }
  }
</style>
{{end}}

{{define "content"}}
<main class="home-content">
  <div class="container">
    <section class="search-section">
      <div class="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="Search notes..." autocomplete="off">
        <span class="search-shortcut">âŒ˜K</span>
        <div class="search-results" id="search-results"></div>
      </div>
    </section>

    <section class="recent-section">
      <h2>Recent</h2>
      <ul class="note-list">
        {{range .RecentNotes}}
        <li class="note-item">
          <div class="note-row">
            <a href="/notes/{{.ID}}.html" class="note-title">{{.Title}}</a>
            {{if .Tags}}
            <div class="note-tags">
              {{range .Tags}}<span class="tag">{{.}}</span>{{end}}
            </div>
            {{end}}
          </div>
        </li>
        {{end}}
      </ul>
    </section>
  </div>
</main>
{{end}}

{{define "scripts"}}
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<script>
  let fuse = null;
  let searchData = [];

  // Load search index
  fetch('/search.json')
    .then(r => r.json())
    .then(data => {
      searchData = data.entries;
      fuse = new Fuse(searchData, {
        keys: ['title', 'tags'],
        threshold: 0.3,
        includeMatches: true
      });
    });

  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  let selectedIndex = -1;

  // Keyboard shortcut
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      searchInput.focus();
    }
  });

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    if (!query || !fuse) {
      searchResults.classList.remove('active');
      return;
    }

    const results = fuse.search(query).slice(0, 10);
    if (results.length === 0) {
      searchResults.classList.remove('active');
      return;
    }

    selectedIndex = -1;
    searchResults.innerHTML = results.map((r, i) => `
      <div class="search-result" data-index="${i}" data-id="${r.item.id}">
        <div class="search-result-title">${r.item.title}</div>
        ${r.item.tags.length ? `<div class="search-result-tags tags">${r.item.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
      </div>
    `).join('');
    searchResults.classList.add('active');

    // Add click handlers
    searchResults.querySelectorAll('.search-result').forEach(el => {
      el.addEventListener('click', () => {
        window.location.href = '/notes/' + el.dataset.id + '.html';
      });
    });
  });

  searchInput.addEventListener('keydown', (e) => {
    const results = searchResults.querySelectorAll('.search-result');
    if (!results.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
      updateSelection(results);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
      updateSelection(results);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      window.location.href = '/notes/' + results[selectedIndex].dataset.id + '.html';
    } else if (e.key === 'Escape') {
      searchResults.classList.remove('active');
      searchInput.blur();
    }
  });

  function updateSelection(results) {
    results.forEach((el, i) => {
      el.classList.toggle('selected', i === selectedIndex);
    });
  }

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.remove('active');
    }
  });
</script>
{{end}}
